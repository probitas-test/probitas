name: Publish

on:
  pull_request:
    types:
      - closed
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to publish (branch, tag, or commit SHA)"
        required: false
        default: "main"

jobs:
  publish:
    if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/'))
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: nixbuild/nix-quick-install-action@v34

      - name: Extract version from deno.json
        id: version
        run: |
          VERSION=$(nix develop -c deno eval "console.log(JSON.parse(Deno.readTextFileSync('deno.json')).version)")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

      - name: Publish to JSR
        run: nix develop -c deno publish

      - name: Create and push tag
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG_NAME="${{ steps.version.outputs.tag }}"

          # Create the tag locally if it does not already exist
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists locally."
          else
            git tag "$TAG_NAME"
          fi

          # Try to push the tag; on failure, emit clear manual recovery instructions
          if git push origin "$TAG_NAME"; then
            echo "Successfully pushed tag $TAG_NAME to origin."
          else
            echo "::error::Failed to push tag $TAG_NAME to origin after publishing to JSR."
            echo "Manual recovery steps:"
            echo "  1. Check out the main branch locally and ensure it is up to date."
            echo "  2. Verify that the current commit matches the published version."
            echo "  3. From your local clone, run:"
            echo "       git tag $TAG_NAME"
            echo "       git push origin $TAG_NAME"
            echo "  4. After the tag is pushed, you may create the corresponding GitHub Release for $TAG_NAME if desired."
            exit 1
          fi

      - name: Create GitHub Release
        run: |
          gh release create ${{ steps.version.outputs.tag }} \
            --title "${{ steps.version.outputs.tag }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: ["publish"]
    if: needs.publish.result == 'success'
    uses: ./.github/workflows/update-homebrew.yml
    secrets: inherit
